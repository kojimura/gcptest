#-------------------
cloud SQL - Cloud Run
#-------------------
1.ファイアウォールルールの確認:
GCP コンソールのファイアウォールルールページで、すべてのルールを確認し、優先度、ソース、ターゲット、プロトコル、ポートなどが意図した設定になっているか確認してください。
Cloud SQLのプライベートIP範囲への出力(egress)を許可するルールとCloud SQLへの入力(ingress)を許可するルールの両方設定が必要です。

2.VPCネットワークの確認:
Cloud SQL インスタンスと Cloud Run サービスが同一の VPC ネットワークに接続されているか確認してください。異なるネットワークの場合は、VPC ピアリングなどを設定する必要があります。
Cloud Run からVPCネットワークに接続するために、サーバーレス VPC アクセスコネクタが正しく構成されているか確認してください。

3.タグの確認:
ファイアウォールルールのタグと Cloud SQL インスタンスのタグが完全に一致しているか確認してください。

4.Cloud SQL のプライベート IP 設定の確認:
Cloud SQL インスタンスのプライベート IP 設定が有効になっているか、および適切な IP 範囲が割り当てられているか確認してください。

5.Cloud Run ネットワーク設定の確認:
Cloud Run からの出力にVPCコネクタを設定しCloud SQLのプライベートIP範囲にトラフィックを送るように設定します。

6.ファイアウォールルールの競合の解消:
重複するルールや不要なルールを削除し、ルールを整理してください。

7.Cloud SQL 接続テスト:
Cloud Shell などからCloud SQLのプライベートIPに接続できるかテストする。

プライベート IP を構成する
https://cloud.google.com/sql/docs/mysql/configure-private-ip?hl=ja

Cloud Run サービスから Cloud SQL にダイレクト VPC 下り (外向き) を使ってプライベート接続する
https://zenn.dev/google_cloud_jp/articles/cloudrun-cloudsql

#-------------------
redis
#-------------------
# Create a Memorystore for Redis instance by using the Google Cloud console

# monitor alert

https://cloud.google.com/memorystore/docs/redis/monitor-instances#set_an_alert_for_high_redis_engine_cpu_utilization
Enter a decimal value between 0 and 1 to indicate the threshold percentage. For example .35 indicates 35%

Cloud Monitoring の概要
https://cloud.google.com/monitoring/docs/monitoring-overview

Redis インスタンスをモニタリングする
https://cloud.google.com/memorystore/docs/redis/monitor-instances?hl=ja

google cloud metrics
https://cloud.google.com/monitoring/api/metrics_gcp#compute/instance/cpu/utilization
Fractional utilization of allocated CPU on this instance. Values are typically numbers between 0.0 and 1.0 (but some machine types allow bursting above 1.0). Charts display the values as a percentage between 0% and 100% (or more). This metric is reported by the hypervisor for the VM and can differ from `agent.googleapis.com/cpu/utilization`, which is reported from inside the VM. Sampled every 60 seconds. After sampling, data is not visible for up to 240 seconds.
instance_name: The name of the VM instance.

Memorystore for Redis でサポートされているモニタリング指標
https://cloud.google.com/memorystore/docs/redis/supported-monitoring-metrics?hl=ja
Redis サーバーによって使用された 1 分あたりの CPU 使用時間。システム / ユーザー空間と親 / 子関係ごとに分けられます。CPU 秒は、Redis サーバーのメインプロセスのすべてのスレッドの合計を示します。メインスレッドの CPU 使用率のみを確認する場合は、メインスレッド CPU 秒の指標を確認します。

指標ベースのアラート ポリシーの動作
https://cloud.google.com/monitoring/alerts/concepts-indepth?hl=ja


Configure the query performance factor for Redis Query Engine in Redis Enterprise
https://redis.io/docs/latest/operate/oss_and_stack/stack-with-enterprise/search/query-performance-factor/

Redis Enterprise Software observability and monitoring guidance
https://redis.io/docs/latest/integrate/prometheus-with-redis-enterprise/observability/

gcloud alpha monitoring policies list
gcloud alpha monitoring policies describe [POLICY_NAME]






#-------------------
artifact registry
#-------------------
containeranalysis.occurrences.list

gcloud projects get-iam-policy [PROJECT_ID] \
  --flatten="bindings[].members" \
  --format='table(bindings.role)' \
  --filter="bindings.members:[ACCOUNT_EMAIL]"

gcloud iam roles describe roles/owner|grep containeranalysis

https://cloud.google.com/artifact-analysis/docs/access-control
https://cloud.google.com/iam/docs/roles-overview?hl=ja

gcloud artifacts repositories list --format="table(name,location,projectId)"

gcloud artifacts repositories describe [REPOSITORY_NAME] --location=[REGION]

gcloud services list --enabled --project=[PROJECT_ID] | grep containeranalysis

gcloud policy-troubleshoot iam troubleshoot --help

gcloud policy-troubleshoot iam //artifactregistry.googleapis.com/projects/PROJECT_ID/locations/asia-northeast1/repositories/REPO_NAME \
  --permission=artifactregistry.repositories.downloadArtifacts \
  --resource-type=artifactregistry.googleapis.com/Repository \
  --principal-email="E_MAIL"

#-------------------
asset inventory
#-------------------
gcloud asset query \
   --folder=[フォルダID] \
    --statement="
      SELECT
        name, assetType
      FROM
         sqladmin_googleapis_com_Instance
      LIMIT 2"

gcloud asset search-all-resources \
   --scope='folders/[フォルダID]' \
   --asset-types='sqladmin.googleapis.com/Instance' \
   --order-by='createTime' --read-mask="*" \
   --format="table(name, versionedResources.resource.region, versionedResources.resource.databaseInstalledVersion, state, versionedResources.resource.settings.activationPolicy)"

[1] https://cloud.google.com/asset-inventory/docs/query-assets-with-sql?hl=ja
[2] https://cloud.google.com/asset-inventory/docs/search-resources?hl=ja#gcloud

